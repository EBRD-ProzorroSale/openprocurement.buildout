#!/bin/bash
ADMIN_COUCH=http://{{parts.project.couchdb_admin_username}}:{{parts.project.couchdb_admin_password}}@{{parts.project.couchdb_host}}:{{parts.project.couchdb_port}}/
curl -HContent-Type:application/json -XPUT $ADMIN_COUCH/{{parts.project.couchdb_backup_db}}
curl -HContent-Type:application/json -XPUT $ADMIN_COUCH/_users/org.couchdb.user:{{parts.project.couchdb_username}} --data-binary '{"_id": "org.couchdb.user:{{parts.project.couchdb_username}}", "name": "{{parts.project.couchdb_username}}", "roles": [],"type": "user","password": "{{parts.project.couchdb_password}}"}'
curl -HContent-Type:application/json -XPOST $ADMIN_COUCH/_replicate --data-binary '{"source":"http://{{parts.project.couchdb_remote_username}}:{{parts.project.couchdb_remote_password}}@{{parts.project.couchdb_remote_host}}:{{parts.project.couchdb_remote_port}}/{{parts.project.couchdb_remote_db}}","target":"http://{{parts.project.couchdb_admin_username}}:{{parts.project.couchdb_admin_password}}@{{parts.project.couchdb_host}}:{{parts.project.couchdb_port}}/{{parts.project.couchdb_backup_db}}"}'
# curl -HContent-Type:application/json -XPOST $ADMIN_COUCH/_replicate --data-binary '{"source":"http://{{parts.project.couchdb_remote_username}}:{{parts.project.couchdb_remote_password}}@{{parts.project.couchdb_remote_host}}:{{parts.project.couchdb_remote_port}}/{{parts.project.couchdb_remote_db}}","target":"http://{{parts.project.couchdb_username}}:{{parts.project.couchdb_password}}@{{parts.project.couchdb_host}}:{{parts.project.couchdb_port}}/{{parts.project.couchdb_backup_db}}"}'